# kehua-tauri

基于 tauri 框架开发的可话第三方 PC 客户端，支持 MacOS/Windows/Linux。

协议主要通过抓包分析，结合对 iOS 端的逆向。

## 可话分析

1. 可话的单聊集成了融信的 SDK，公钥在前端。但常规的点亮动态聊天是走的自己的评论系统。
2. 接收验证码等操作前需要过极验证 SDK，每次使用前先走后端验证。
3. 可话较多地使用了 websocket 长连接来处理实时消息，评论的发送也是走 ws，不过失败时会降级到 http(s)请求。
4. 登录 token，前端用公钥做了一次加密，搞得外形上像 JWT，唯一的意义是增加一点点前端逆向成本。
5. 图片用的 ucloud 的存储，us3 相关 API。每次使用前先走后端验证。注意这里限制了只允许 PUT 接口，不允许表单提交。

## 技术选型

目标是跨平台桌面端，考虑 web 和 flutter 两类方案。由于极验证在桌面端只支持 web，放弃 flutter 方案。

web 方案里，考虑 electron、tauri、PWA。首先排除 PWA，因为无法解决网络跨域的问题。

比较 electron 和 tauri 后最终选择了 tauri，原因如下：

1. tauri 使用系统 webview，安装包更精简，符合我的个人技术审美。
2. tauri 的一致性没有 electron 那么强，但我这个场景下没有那么强的需求。
3. tauri 的后端用的 rust，有助于我个人技术提升。

## 感想

开发一些内容后，对于集成 webkit 和使用系统 webview 的差异有了更多的理解，一致性只是一个方面。使用系统 webview，很多 api 还是会受到浏览器限制，需要通过 JSAPI 来补充。比如网络请求，使用 webview 的请求就无法绕过跨域问题。比如文件 API，使用 webview 的接口，无法拿到完整文件路径。 Tauri 提供了一些 API 来绕过这些问题，但总体上实现不会很漂亮，对原有网页的迁移封装也做不到无感。而 electron 这样的集成环境，可以自行修改 webkit 来解决这些问题。
